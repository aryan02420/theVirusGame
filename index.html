<!DOCTYPE html>
<html lang="en">

<head>
  <script src="js/p5.js"></script>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="./" target="_blank">
</head>

<body>
  <h1>The Virus Game</h1>
  <div id="game-canvas"></div>
  <br>
  <section id="info">
    <h3>How to Play</h3>
    <p>
      <ul>
        <li>A virus can either donate or take energy from each virus it is connected to.</li>
        <li>Press âŠ™ to change between donate and take.</li>
        <li>Tap a virus to perform the action.</li>
        <li>The game is completed when none of the viruses have negative energy.</li>
      </ul>
    </p>
  </section>
  <section>
    <h3>Game State</h3>
    <div id="configgrid">
      <textarea id="gamestate" value='' onchange=""></textarea>
      <button id="gamestate-load" onclick="resetup();">Load</button>
      <button id="gamestate-download"><a href="" id="gamestate-download-link" download="virus.txt">Download</a></button>
      <div>
        <label for="gamestate-file" onchange="previewFile()">From File:</label>
        <input type="file" name="gamestate-file" id="gamestate-file" />
      </div>
      <div>
        <label for="gamestate-presets">Presets:</label>
        <select name="gamestate-presets" id="gamestate-presets" oninput="loadpreset()">
          <option value="custom">custom</option>
        </select>
      </div>
    </div>
  </section>
  <script src="js/gamedata.js"></script>
  <script>
    function changeGamestate(data) {
      document.getElementById('gamestate').value = JSON.stringify(data, null, 2);
      setup();
      document.location = '#';
      setDownloadURL();
    }

    function loadpreset() {
      let d = document.getElementById('gamestate-presets').value;
      changeGamestate(gamedata[d]);
    }

    function setDownloadURL() {
      const e = document.getElementById('gamestate-download-link');
      const t = document.getElementById('gamestate');
      const d = encodeURIComponent(t.value);
      e.setAttribute("href", 'data:text/html;charset=utf-8,' + d);
    }

    // read and display file
    // https://stackoverflow.com/questions/18933085/display-text-file-in-javascript
    document
    .getElementById('gamestate-file')
    .addEventListener(
        'input',
        function () {
            var fr = new FileReader();
            fr.onload = function () {
                document.getElementById('gamestate').value = this.result;
                resetup();
                document.getElementById('gamestate-file').value="";
            };
            fr.readAsText(this.files[0]);
        }
    );

    for (preset of Object.keys(gamedata)) {
      parent = document.getElementById('gamestate-presets');
      parent.innerHTML += '<option value="' + preset + '">' + preset + '</option>';
    }


    changeGamestate(gamedata.normal);
  </script>
  <script src="js/sketch.js"></script>
</body>

</html>
